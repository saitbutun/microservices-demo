apiVersion: batch/v1
kind: Job
metadata:
  name: vault-bootstrap
  namespace: vault
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: vault
      restartPolicy: OnFailure
      containers:
        - name: vault-bootstrap
          image: hashicorp/vault:1.15.0
          env:
            # KRÄ°TÄ°K DEÄÄ°ÅÄ°KLÄ°K BURADA: Direkt pod adresine gidiyoruz
            - name: VAULT_ADDR
              value: "http://vault-0.vault-internal:8200"
          command:
            - /bin/sh
            - -c
            - |
              set -e
              apk add --no-cache jq curl

              echo "â³ Vault Pod'una (vault-0) baÄŸlanÄ±lÄ±yor..."
              
              # Vault cevap verene kadar bekle (200=Active, 501=Not Init, 503=Sealed)
              until curl -s -o /dev/null --fail $VAULT_ADDR/v1/sys/health || [ $? -eq 22 ] || [ $? -eq 7 ]; do
                 echo "Vault henÃ¼z socket aÃ§madÄ±, bekleniyor..."
                 sleep 2
              done

              echo "âœ… Vault'a eriÅŸildi."

              # 1. INITIALIZE & LOGIN
              INIT_STATUS=$(curl -s $VAULT_ADDR/v1/sys/init | jq -r .initialized)
              
              if [ "$INIT_STATUS" = "false" ]; then
                 echo "ğŸš€ Vault Initialize ediliyor..."
                 vault operator init -key-shares=1 -key-threshold=1 -format=json > /tmp/init.json
                 
                 ROOT_TOKEN=$(jq -r .root_token /tmp/init.json)
                 UNSEAL_KEY=$(jq -r .unseal_keys_b64[0] /tmp/init.json)
                 
                 echo "=================================================="
                 echo "ğŸ”¥ ROOT TOKEN: $ROOT_TOKEN"
                 echo "ğŸ”¥ UNSEAL KEY: $UNSEAL_KEY"
                 echo "=================================================="
                 
                 vault operator unseal $UNSEAL_KEY
                 vault login $ROOT_TOKEN
              else
                 echo "âš ï¸ Vault zaten init edilmiÅŸ. Root token yoksa script devam edemez."
                 # EÄŸer unseal durumda deÄŸilse unseal etmeyi deneyelim (key elimizde yok ama logic olarak bulunsun)
                 SEAL_STATUS=$(curl -s $VAULT_ADDR/v1/sys/health | jq -r .sealed)
                 if [ "$SEAL_STATUS" = "true" ]; then
                    echo "âŒ Vault kilitli (Sealed)! Manuel unseal gerekli Ã§Ã¼nkÃ¼ key bende yok."
                    exit 1
                 fi
                 exit 0
              fi

              # 2. AYARLARI YAP
              echo "ğŸ“¦ KV Secret Engine..."
              vault secrets enable -path=secret kv-v2 || true
              
              echo "ğŸ“ Secret ekleniyor..."
              vault kv put secret/sockshop/redis password="INITIALPASSWORD"

              echo "ğŸ”‘ Kubernetes Auth..."
              vault auth enable kubernetes || true

              echo "âš™ï¸ K8s Auth Config..."
              vault write auth/kubernetes/config \
                kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"

              echo "ğŸ“œ Policy..."
              cat <<EOF > /tmp/sockshop-policy.hcl
              path "secret/data/sockshop/redis" {
                capabilities = ["read"]
              }
              EOF
              vault policy write sockshop-policy /tmp/sockshop-policy.hcl

              echo "ğŸ”— Role..."
              vault write auth/kubernetes/role/sockshop-role \
                bound_service_account_names=cartservice \
                bound_service_account_namespaces=default \
                policies=sockshop-policy \
                ttl=1h

              echo "âœ… BÄ°TTÄ° KANKA!"