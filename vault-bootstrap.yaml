apiVersion: batch/v1
kind: Job
metadata:
  name: vault-bootstrap
  namespace: vault
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: vault
      containers:
        - name: vault-bootstrap
          image: alpine:3.19
          env:
            - name: VAULT_ADDR
              value: http://vault.vault.svc.cluster.local:8200
          command:
            - /bin/sh
            - -c
            - |
              set -e

              apk add --no-cache vault jq netcat-openbsd

              echo "â³ Vault port bekleniyor..."
              until nc -z vault.vault.svc.cluster.local 8200; do
                sleep 2
              done

              echo "âœ… Vault port aÃ§Ä±k"

              INIT=$(vault status -format=json 2>/dev/null | jq -r .initialized || echo "false")

              if [ "$INIT" = "false" ]; then
                echo "ğŸš€ Vault init ediliyor"
                vault operator init -key-shares=1 -key-threshold=1 -format=json > /tmp/init.json
              else
                echo "â„¹ï¸ Vault zaten init edilmiÅŸ"
                exit 0
              fi

              UNSEAL_KEY=$(jq -r .unseal_keys_b64[0] /tmp/init.json)
              ROOT_TOKEN=$(jq -r .root_token /tmp/init.json)

              vault operator unseal "$UNSEAL_KEY"
              vault login "$ROOT_TOKEN"

              echo "ğŸ” KV engine"
              vault secrets enable -path=secret kv-v2 || true

              echo "ğŸ“œ Policy"
              vault policy write sockshop-policy - <<EOF
              path "secret/data/sockshop/redis" {
                capabilities = ["read"]
              }
              EOF

              echo "ğŸ”— Kubernetes auth"
              vault auth enable kubernetes || true

              vault write auth/kubernetes/config \
                kubernetes_host="https://kubernetes.default.svc:443"

              echo "ğŸ¯ Role"
              vault write auth/kubernetes/role/sockshop-role \
                bound_service_account_names=cartservice \
                bound_service_account_namespaces=default \
                policies=sockshop-policy \
                ttl=1h

              echo "âœ… Vault bootstrap tamamlandÄ±"
