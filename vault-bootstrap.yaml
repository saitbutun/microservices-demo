apiVersion: batch/v1
kind: Job
metadata:
  name: vault-bootstrap
  namespace: vault
spec:
  backoffLimit: 0
  template:
    spec:
      serviceAccountName: vault
      restartPolicy: Never
      containers:
        - name: vault-bootstrap
          image: hashicorp/vault:1.15.0
          env:
            - name: VAULT_ADDR
              value: "http://vault-0.vault-internal:8200"
          command:
            - /bin/sh
            - -c
            - |
              set -e
              apk add --no-cache jq curl

              echo " Vault ($VAULT_ADDR) bekleniyor..."
              while ! curl -s -o /dev/null $VAULT_ADDR/v1/sys/health; do
                  sleep 2
              done
              echo "Vault bağlantısı sağlandı."

              INIT_STATUS=$(curl -s $VAULT_ADDR/v1/sys/init | jq -r .initialized)

              if [ "$INIT_STATUS" = "false" ]; then
                  echo "Vault Initialize ediliyor (AUTO-UNSEAL)..."
                  
                  # KMS olduğu için -recovery-shares kullanıyoruz
                  vault operator init -recovery-shares=1 -recovery-threshold=1 -format=json > /tmp/init.json
                  
                  ROOT_TOKEN=$(jq -r .root_token /tmp/init.json)
                  # DİKKAT: KMS modunda 'unseal_keys_b64' YOKTUR, 'recovery_keys_b64' VARDIR.
                  RECOVERY_KEY=$(jq -r .recovery_keys_b64[0] /tmp/init.json)

                  echo "=================================================="
                  echo "ROOT TOKEN: $ROOT_TOKEN"
                  echo "RECOVERY KEY: $RECOVERY_KEY"
                  echo "=================================================="

                  vault login $ROOT_TOKEN
              else
                  echo " Vault zaten init edilmiş."
                  exit 1
              fi

              echo "Konfigürasyon..."
              vault secrets enable -path=secret kv-v2 || true
              vault auth enable kubernetes || true
              vault write auth/kubernetes/config kubernetes_host="https://kubernetes.default.svc:443"
              
              vault kv put secret/sockshop/redis password="RedisPassword123!"
              #vault kv put secret/sockshop/config db-password="PostgresPassword123!"

              cat <<EOF > /tmp/policy.hcl
              path "secret/data/sockshop/*" { capabilities = ["read"] }
              EOF
              vault policy write sockshop-policy /tmp/policy.hcl

              vault write auth/kubernetes/role/sockshop-role \
                bound_service_account_names=cartservice,frontend,default,redis-cart \
                bound_service_account_namespaces=default \
                policies=sockshop-policy \
                ttl=24h

              echo "KURULUM TAMAM! Auto-Unseal aktif."
  ttlSecondsAfterFinished: 600
          